\pgfplotsset{
    discard if/.style 2 args={
        x filter/.code={
            \edef\tempa{\thisrow{#1}}
            \edef\tempb{#2}
            \ifx\tempa\tempb
                \def\pgfmathresult{inf}
            \fi
        }
    },
    discard if not/.style 2 args={
        x filter/.code={
            \edef\tempa{\thisrow{#1}}
            \edef\tempb{#2}
            \ifx\tempa\tempb
            \else
                \def\pgfmathresult{inf}
            \fi
        }
    }
  }

  \begin{tikzpicture}[font=\bf\sffamily\fontsize{8}{10}\selectfont]
  \def\TEXTCOL{gray}
  \tikzset{
    hatch distance/.store in=\hatchdistance,
    hatch distance=20pt,
    hatch thickness/.store in=\hatchthickness,
    hatch thickness=2pt
  }


\pgfplotsset{
    accommodate labels/.code 2 args={
        \newlength{\myl}
        \pgfplotstableread{#1}\data
        \def\largestlength{0}
        \pgfplotstableforeachcolumnelement{#2}\of\data\as\cell{
            \settowidth{\myl}{\pgfinterruptpicture\cell\endpgfinterruptpicture}
            \pgfmathsetmacro\largestlength{max(\the\myl,\largestlength)}
        }
        \pgfplotsset{
            enlarge x limits={
                upper,              value=1/(1-(\largestlength+4pt)/\pgfkeysvalueof{/pgfplots/width})-1
            }
        }
    }
}

\def\COLDR{white}
\definecolor{alizarin}{rgb}{0.82, 0.1, 0.26}
\definecolor{amber}{rgb}{1.0, 0.75, 0.0}
\definecolor{amethyst}{rgb}{0.6, 0.4, 0.8}
\definecolor{apricot}{rgb}{0.98, 0.81, 0.69}
\definecolor{atomictangerine}{rgb}{1.0, 0.6, 0.4}
\definecolor{awesome}{rgb}{1.0, 0.13, 0.32}
\definecolor{azurec}{rgb}{0.0, 0.5, 1.0}
\definecolor{ballblue}{rgb}{0.13, 0.67, 0.8}
\definecolor{bittersweet}{rgb}{1.0, 0.44, 0.37}
\definecolor{bluem}{rgb}{0.0, 0.5, 0.69}
\definecolor{brightturquoise}{rgb}{0.03, 0.91, 0.87}

\def\COLBA{Red2}
\def\COLBB{Red3}
\def\COLBI{Red4}
\def\COLBG{DarkOrange2}
\def\COLBC{lightgray}
\def\COLBD{ballblue}
\def\COLBE{MidnightBlue}
\def\COLBF{SeaGreen3}
\def\COLBH{DarkSlateGray}
\def\COLBJ{bittersweet}
\def\COLBK{Orchid3}
\def\COLBL{black}
  
  \makeatletter
  \pgfdeclarepatternformonly[\hatchdistance,\hatchthickness]{flexible hatch}
  {\pgfqpoint{0pt}{0pt}}
  {\pgfqpoint{\hatchdistance}{\hatchdistance}}
  {\pgfpoint{\hatchdistance-1pt}{\hatchdistance-1pt}}%
  {
    \pgfsetcolor{\tikz@pattern@color}
    \pgfsetlinewidth{\hatchthickness}
    \pgfpathmoveto{\pgfqpoint{0pt}{0pt}}
    \pgfpathlineto{\pgfqpoint{\hatchdistance}{\hatchdistance}}
    \pgfusepath{stroke}
  }
  \makeatother
  \pgfdeclarepatternformonly{north east lines wide}%
  {\pgfqpoint{-1pt}{-1pt}}%
  {\pgfqpoint{10pt}{10pt}}%
  {\pgfqpoint{9pt}{9pt}}%
  {
    \pgfsetlinewidth{0.4pt}
    \pgfpathmoveto{\pgfqpoint{0pt}{0pt}}
    \pgfpathlineto{\pgfqpoint{9.1pt}{9.1pt}}
    \pgfusepath{stroke}
  }


  \def\DISX{../data/figfiles/MFXcodes_short.csv}
  \def\DISM{../data/figfiles/MFcodes.csv}
  \def\DISMM{../data/figfiles/testFcodes.csv}
  \def\DISFF{../data/figfiles/testMcodes.csv}
  
  \def\HGT{4in}
  \def\HGTA{5in}
  \def\WDT{1.5in}
  \def\WDTX{2.250in}
  \def\HGTX{9in}
  \def\OPC{1}
  \def\BWIDTH{9pt}
  \def\BWIDTHB{15pt}
  \clip (.7in,0.25in) rectangle (7.75in,-8.75in);

  \node [anchor=north west,align=left] (A) at (0,0) {
        \begin{tikzpicture}[text=\TEXTCOL]
   \begin{axis}[legend style={anchor=east,at={(0.5,1.05)},inner sep=3pt,draw=none,fill=white,fill opacity=.85,align=right,text opacity=1,font=\bf\sffamily\fontsize{8}{9}\selectfont},axis line style={lightgray, opacity=0, thin},%
        enlargelimits=false,
        % grid,
        % xshift=.1in,
        anchor=north west,
        height=\HGTX,
        width=\WDTX,
        % xbar,
        ytick=data,% crucial line for the xticklabels directive 
        % ymin=0,
        %accommodate labels={\DISX}{description},
        yticklabels from table={\DISFF}{code},
        yticklabel style
        ={font=\bf\sffamily\fontsize{7}{7}\selectfont,
          align=right,rotate=0, text width=1.1in,
          anchor=east, yshift=0in,xshift=-.0450in,text=\TEXTCOL},
        major tick length=0pt,
        xticklabel style=
        {font=\bf\sffamily\fontsize{7}{7}\selectfont,
          text=\TEXTCOL},
        grid,
        grid style={lightgray, dashed,opacity=.7},
        axis on top=false, bar width=\BWIDTH,
        xlabel={$\leftarrow$ TN $\Delta$-frequency TP $\rightarrow$},
        scaled x ticks=false,
        xlabel style={yshift=0.05in,text=\TEXTCOL},
        ylabel style={yshift=0.075in,text=\TEXTCOL},
        enlarge y limits=0.045,
         x tick label style={/pgf/number format/fixed,/pgf/number format/precision=2,/pgf/number format/fixed zerofill,
     /pgf/number format/1000 sep = %\thinspace % Optional if you want to replace comma as the 1000 separator 
   },
   nodes near coords,
    every node near coord/.append style={anchor=west,align=left, text width=2in,font=\sffamily\rm\fontsize{8}{8}\selectfont,text=darkgray},
   point meta=explicit symbolic,ylabel={ICD9 codes},
   , xtick ={-0.03,0,0.03},
   xmax=0.03,xmin=-0.03,
        ] 

        \addplot[fill=lightgray,xbar,area legend,opacity=\OPC,text opacity=\OPC] table [ 
        y expr=\coordindex,
        x=pn
        ] {\DISFF};

        \addplot[draw=\COLDR,fill=\COLBA,xbar,area legend,opacity=\OPC,text opacity=\OPC] table [ 
        y expr=\coordindex,
        x=pn, discard if not={category}{0}
        ] {\DISFF};
        \addplot[draw=\COLDR,fill=\COLBB,xbar,area legend,opacity=\OPC,text opacity=\OPC] table [ 
        y expr=\coordindex,
        x=pn, discard if not={category}{2}
        ] {\DISFF};
        \addplot[draw=\COLDR,fill=\COLBC,xbar,area legend,opacity=\OPC,text opacity=\OPC] table [ 
        y expr=\coordindex,
        x=pn, discard if not={category}{4}
        ] {\DISFF};
        \addplot[draw=\COLDR,fill=\COLBD,xbar,area legend,opacity=\OPC,text opacity=\OPC] table [ 
        y expr=\coordindex,
        x=pn, discard if not={category}{5}
        ] {\DISFF};
        \addplot[draw=\COLDR,fill=\COLBE,xbar,area legend,opacity=\OPC,text opacity=\OPC] table [ 
        y expr=\coordindex,
        x=pn, discard if not={category}{6}
        ] {\DISFF};
        \addplot[draw=\COLDR,fill=\COLBF,xbar,area legend,opacity=\OPC,text opacity=\OPC] table [ 
        y expr=\coordindex,
        x=pn, discard if not={category}{7}
        ] {\DISFF};
        \addplot[draw=\COLDR,fill=\COLBG,xbar,area legend,opacity=\OPC,text opacity=\OPC] table [ 
        y expr=\coordindex,
        x=pn, discard if not={category}{8}
        ] {\DISFF};
        \addplot[draw=\COLDR,fill=\COLBH,xbar,area legend,opacity=\OPC,text opacity=\OPC] table [
        y expr=\coordindex,
        x=pn, discard if not={category}{9}
        ] {\DISFF};
        \addplot[draw=\COLDR,fill=\COLBI,xbar,area legend,opacity=\OPC,text opacity=\OPC] table [ 
        y expr=\coordindex,
        x=pn, discard if not={category}{11}
        ] {\DISFF};
        \addplot[draw=\COLDR,fill=\COLBJ,xbar,area legend,opacity=\OPC,text opacity=\OPC] table [ 
        y expr=\coordindex,
        x=pn, discard if not={category}{13}
        ] {\DISFF};
        \addplot[draw=\COLDR,fill=\COLBK,xbar,area legend,opacity=\OPC,text opacity=\OPC] table [ 
        y expr=\coordindex,
        x=pn, discard if not={category}{14}
        ] {\DISFF};
        \addplot[draw=\COLDR,fill=\COLBL,xbar,area legend,opacity=\OPC,text opacity=\OPC] table [ 
        y expr=\coordindex,
        x=pn, discard if not={category}{15}
        ] {\DISFF};
        % \addlegendentry{Female}
      \end{axis}
      \end{tikzpicture}};



  \node [anchor=north west,align=left] (B) at ([xshift=-2.5in]A.north east) {
        \begin{tikzpicture}[text=\TEXTCOL]
   \begin{axis}[legend style={anchor=east,at={(0.5,1.05)},inner sep=3pt,draw=none,fill=white,fill opacity=.85,align=right,text opacity=\OPC,font=\bf\sffamily\fontsize{8}{9}\selectfont},axis line style={lightgray, opacity=0, thin},%
        %enlargelimits=false,
        % grid,
        % xshift=.1in,
        anchor=north west,
        height=\HGTX,
        width=\WDTX,
        %xbar, 
        ytick=data,% crucial line for the xticklabels directive 
        % ymin=0,
        %accommodate labels={\DISX}{description},
        yticklabels from table={\DISMM}{code},
        yticklabel style
        ={font=\bf\sffamily\fontsize{7}{7}\selectfont,
          align=right,rotate=0, text width=1.1in,
          anchor=east, yshift=0in,xshift=-.0450in,text=\TEXTCOL},
        major tick length=0pt,
        xticklabel style=
        {font=\bf\sffamily\fontsize{7}{7}\selectfont,
          text=\TEXTCOL},
        grid,
        grid style={lightgray, dashed,opacity=.7},
        axis on top=false, bar width=\BWIDTH,
        xlabel={$\leftarrow$ TN $\Delta$-frequency TP $\rightarrow$},
        scaled x ticks=false,
        xlabel style={yshift=0.05in,text=\TEXTCOL},
        ylabel style={yshift=0.075in,text=\TEXTCOL},
        enlarge y limits=0.03,
         x tick label style={/pgf/number format/fixed,/pgf/number format/precision=2,/pgf/number format/fixed zerofill,
     /pgf/number format/1000 sep = %\thinspace % Optional if you want to replace comma as the 1000 separator 
   },
   nodes near coords,
    every node near coord/.append style={anchor=west,align=left, text width=2in,font=\sffamily\rm\fontsize{8}{8}\selectfont,text=darkgray},
   point meta=explicit symbolic,%ylabel={ICD9 codes},
, xtick ={-0.03,0,0.03},xmin=-0.03,xmax=0.03
        ] 

        \addplot[fill=lightgray,xbar,area legend,opacity=\OPC,text opacity=\OPC] table [ 
        y expr=\coordindex,
        x=pn
        ] {\DISMM};

        \addplot[draw=white,fill=\COLBA,xbar,area legend,opacity=\OPC,text opacity=\OPC] table [ 
        y expr=\coordindex,
        x=pn, discard if not={category}{0}
        ] {\DISMM};
        \addplot[draw=\COLDR,fill=\COLBB,xbar,area legend,opacity=\OPC,text opacity=\OPC] table [ 
        y expr=\coordindex,
        x=pn, discard if not={category}{2}
        ] {\DISMM};
        \addplot[draw=\COLDR,fill=\COLBC,xbar,area legend,opacity=\OPC,text opacity=\OPC] table [ 
        y expr=\coordindex,
        x=pn, discard if not={category}{4}
        ] {\DISMM};
        \addplot[draw=\COLDR,fill=\COLBD,xbar,area legend,opacity=\OPC,text opacity=\OPC] table [ 
        y expr=\coordindex,
        x=pn, discard if not={category}{5}
        ] {\DISMM};
        \addplot[draw=\COLDR,fill=\COLBE,xbar,area legend,opacity=\OPC,text opacity=\OPC] table [ 
        y expr=\coordindex,
        x=pn, discard if not={category}{6}
        ] {\DISMM};
        \addplot[draw=\COLDR,fill=\COLBF,xbar,area legend,opacity=\OPC,text opacity=\OPC] table [ 
        y expr=\coordindex,
        x=pn, discard if not={category}{7}
        ] {\DISMM};
        \addplot[draw=\COLDR,fill=\COLBG,xbar,area legend,opacity=\OPC,text opacity=\OPC] table [ 
        y expr=\coordindex,
        x=pn, discard if not={category}{8}
        ] {\DISMM};
        \addplot[draw=\COLDR,fill=\COLBH,xbar,area legend,opacity=\OPC,text opacity=\OPC] table [ 
        y expr=\coordindex,
        x=pn, discard if not={category}{9}
        ] {\DISMM};
        \addplot[draw=\COLDR,fill=\COLBI,xbar,area legend,opacity=\OPC,text opacity=\OPC] table [ 
        y expr=\coordindex,
        x=pn, discard if not={category}{11}
        ] {\DISMM};
        \addplot[draw=\COLDR,fill=\COLBJ,xbar,area legend,opacity=\OPC,text opacity=\OPC] table [ 
        y expr=\coordindex,
        x=pn, discard if not={category}{13}
        ] {\DISMM};
        \addplot[draw=\COLDR,fill=\COLBK,xbar,area legend,opacity=\OPC,text opacity=\OPC] table [ 
        y expr=\coordindex,
        x=pn, discard if not={category}{14}
        ] {\DISMM};
        \addplot[draw=\COLDR,fill=\COLBL,xbar,area legend,opacity=\OPC,text opacity=\OPC] table [ 
        y expr=\coordindex,
        x=pn, discard if not={category}{15}
        ] {\DISMM};
      \end{axis}
      \end{tikzpicture}};
    \node[fill=white] (T) at ([xshift=-.5in,yshift=2.25in]B.east) {
      \arrayrulecolor{white}
      \setlength\arrayrulewidth{2pt}
      \mnp{2in}{\fontsize{7}{8}\selectfont\color{\TEXTCOL}
        {\large ICD9 Classification Key}
        \vskip 2em
        \begin{tabular}{L{.1in}L{1.5in}}
          \cellcolor{\COLBA} & Infections \\\hline  %0
          \cellcolor{\COLBB} & Endocrine \& Immun. Dis.\\\hline %2
          \cellcolor{\COLBI} & Skin \& subcut. tiss.\\\hline    %4
          \cellcolor{\COLBG} & Digestive Dis.\\\hline           %5
          \cellcolor{\COLBC} & Mental Dis.\\\hline              %6
          \cellcolor{\COLBD} & Nervous Dis.\\\hline             %7
          \cellcolor{\COLBE} & Circulatory Dis.\\\hline         %8
          \cellcolor{\COLBF} & Respiratory Dis.\\\hline         %9
          \cellcolor{\COLBH} & Genitourinary Dis.\\\hline       %11
          \cellcolor{\COLBJ} & Congenital Anomaly\\\hline       %13
          \cellcolor{\COLBK} & Cond. orig. in Perinatal Per.\\\hline %14
          \cellcolor{\COLBL} & Ill-defined Cond. \& Symptoms    %15
          \end{tabular}
        }
      };

  \node [anchor=south west,align=left] (R) at ([xshift=-2.65in,yshift=0in]B.south east) {
    \begin{tikzpicture}[text=\TEXTCOL]
      \def\OPC{.35}
      \begin{axis}[legend style={anchor=east,at={(0.5,1.05)},inner sep=3pt,draw=none,fill=white,fill opacity=.850,align=right,text opacity=1,font=\bf\sffamily\fontsize{6}{9}\selectfont},axis line style={lightgray, opacity=0, thin},%
        %enlargelimits=true,
        % grid,
        % xshift=.1in,
        anchor=north west,
        height=\HGT,
        width=\WDT,
        %xbar, 
        ytick=data,% crucial line for the xticklabels directive 
        % ymin=0,
        %accommodate labels={\DISX}{description},
        yticklabels from table={\DISX}{code},
        yticklabel style
        ={font=\bf\sffamily\fontsize{7}{7}\selectfont,
          align=right,rotate=0, text width=1.1in,
          anchor=east, yshift=0in,xshift=-.045in,text=\TEXTCOL},
        major tick length=0pt,
        xticklabel style=
        {font=\bf\sffamily\fontsize{7}{7}\selectfont,
          text=\TEXTCOL},
        grid,
        grid style={lightgray, dashed,opacity=.5},
        axis on top=false, bar width=\BWIDTHB,
        xlabel={$\leftarrow$ TN $\Delta$-frequency TP $\rightarrow$},
        scaled x ticks=false,
        xlabel style={yshift=0.05in,text=\TEXTCOL},
        ylabel style={yshift=0.075in,text=\TEXTCOL},
        % enlarge y limits=0.03, 
         x tick label style={/pgf/number format/fixed,/pgf/number format/precision=2,/pgf/number format/fixed zerofill,
     /pgf/number format/1000 sep = %\thinspace % Optional if you want to replace comma as the 1000 separator 
   },
   nodes near coords,,visualization depends on=x \as \rawx,
    every node near coord/.append style={anchor=west,align=left, text width=1.4in,font=\sffamily\rm\fontsize{7}{8}\selectfont,text=darkgray,text opacity=1,
        shift={(axis direction cs:0.00-0.02*\rawx*\coordindex+0*\rawx*\rawx,0)}},
      point meta=explicit symbolic,
      ylabel={}, xtick ={-0.04,0,0.040}
        ] 

        \addplot[opacity=1,fill opacity=.5,text opacity=1,fill=\MXCOL,xbar,area legend] table [ 
        y expr=\coordindex,
        x=pnM
        ] {\DISX};   
        \addlegendentry{Male}
        \addplot[opacity=\OPC,text opacity=1,fill=\FXCOL,,postaction={
        pattern=north east lines
    },xbar,area legend] table [ 
        y expr=\coordindex,
        x=pnF,meta=description
        ] {\DISX};   
        \addlegendentry{Female}
        % \addplot[opacity=1,fill=\FXCOL] table [ 
        % y expr=\coordindex,
        % x=F
        % ] {\IMP};   
        % \addlegendentry{Female}
      \end{axis} 
    \end{tikzpicture}
  };



      
  \node[anchor=south west,align=left] (LA) at ([xshift=1in,yshift=0in]A.north west) {{\LARGE A.} Male };
  \node[anchor=south west,align=left] (LB) at ([xshift=2.5in,yshift=0in]$(LA.north west)!(B.north)!(LA.south west)$) {{\LARGE B.} Female };
  
  \node[anchor=south west,align=left] (LC) at ([xshift=1in,yshift=0.15in]R.north west) {{\LARGE C.} Codes with\\Maximum Mismatch Across Genders};
  
\end{tikzpicture}

